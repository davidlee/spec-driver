---
id: DE-004
slug: phase-management-implementation
name: Delta - Phase Management Implementation
created: '2025-11-02'
updated: '2025-11-02'
status: draft
kind: delta
aliases: []
relations: []
applies_to:
  specs:
  - PROD-006
  requirements: []
---

# DE-004 – Phase Management Implementation

```yaml supekku:delta.relationships@v1
schema: supekku.delta.relationships
version: 1
delta: DE-004
revision_links:
  introduces: []
  supersedes: []
specs:
  primary:
    - PROD-006
  collaborators: []
requirements:
  implements:
    - PROD-006.FR-001
    - PROD-006.FR-002
    - PROD-006.FR-003
    - PROD-006.FR-004
    - PROD-006.FR-005
    - PROD-006.NF-001
    - PROD-006.NF-002
  updates: []
  verifies: []
phases:
  - id: IP-004.PHASE-01
  - id: IP-004.PHASE-02
  - id: IP-004.PHASE-03
  - id: IP-004.PHASE-04
  - id: IP-004.PHASE-05
```

## 1. Summary & Context
- **Product Spec(s)**: PROD-006 – Phase Management (create phase command, enhanced delta display, metadata validation)
- **Technical Spec(s)**: SPEC-003 (CLI create), SPEC-006 (CLI show), SPEC-054 (change formatters) will be updated
- **Implementation Plan**: [IP-004](./IP-004.md) – draft, 5 phases planned (Phase 04 added 2025-11-03 for plan metadata auto-update, Phase 05 added for structured progress tracking)
- **Change Drivers**: Manual phase creation is error-prone and time-consuming; need tooling to reduce toil

## 2. Motivation
- Currently creating phases requires manually copying templates, filling frontmatter, ensuring correct IDs and relationships
- Phase information not visible via `show delta` - requires reading multiple files
- No validation for phase.overview schema - errors discovered late
- Manual workflow takes ~5 minutes per phase, error rate ~20% (metadata mistakes)
- This delta enables PROD-006 capabilities: phase creation, visibility, and validation

## 3. Scope & Objectives
- **Primary Outcomes**:
  - `spec-driver create phase "Name" --plan IP-XXX` command working (PROD-006.FR-001, FR-002, FR-004)
  - `spec-driver show delta DE-XXX` displays phase information (PROD-006.FR-003)
  - Phase metadata validated during sync (PROD-006.FR-005)
  - Phase creation time reduced from 5min to <30sec (PROD-006.NF-001)
  - All 8 verification artifacts passing (VT-PHASE-001 through VT-PHASE-007, VA-PHASE-001, VA-PHASE-002)
  - **[Added 2025-11-03]** Automatic plan frontmatter updates when creating phases (ensures `show delta --json` consistency)
  - **[Added 2025-11-03]** Structured progress tracking via phase.tracking@v1 block (replaces regex-based task counting)
- **Operational Constraints**: Solo developer, no breaking changes to existing phase files, maintain skinny CLI pattern
- **Dependencies**: None - self-contained change

## 4. Out of Scope
- Phase status tracking (planned → in-progress → complete)
- `list phases` or `show phase` commands
- Gate validation (entrance/exit criteria checking)
- Phase templates by type
- Phase deletion or reordering
- Automatic delta frontmatter updates (delta.relationships block phase list)

## 5. Approach Overview
- **System Touchpoints**:
  - `supekku/cli/create.py` - add phase command
  - `supekku/scripts/lib/changes/creation.py` - phase creation logic
  - `supekku/scripts/lib/formatters/change_formatters.py` - enhance delta display
  - `supekku/scripts/lib/changes/blocks/` - phase metadata parsing (may already exist)
  - `supekku/templates/phase.md` - already exists, may need updates

- **Key Changes**:
  - Add `create_phase()` function following existing `create_delta()` pattern
  - Implement phase numbering logic by scanning existing phase files
  - Enhance `format_delta_details()` to show phase summaries with objectives
  - Add schema validation for `phase.overview` blocks in sync process
  - Template variable substitution for phase ID, plan ID, delta ID

- **Migration / Rollout Notes**: No migration needed - existing phase files unaffected, new capability only

## 6. Verification Strategy
- **Requirements Coverage**:
  - PROD-006.FR-001: VT-PHASE-001 (unit tests for phase creation)
  - PROD-006.FR-002: VT-PHASE-002 (auto-increment numbering tests)
  - PROD-006.FR-003: VT-PHASE-003 (formatter output tests)
  - PROD-006.FR-004: VT-PHASE-004 (metadata population tests)
  - PROD-006.FR-005: VT-PHASE-005 (schema validation tests)
  - PROD-006.NF-001: VA-PHASE-001 (performance benchmarks)
  - PROD-006.NF-002: VA-PHASE-002 (UX review of display)

- **Planned Artefacts**:
  - Phase 01: VT-PHASE-001, VT-PHASE-002, VT-PHASE-004 (creation logic)
  - Phase 02: VT-PHASE-003 (formatter), VT-PHASE-005 (validation)
  - Phase 03: VA-PHASE-001, VA-PHASE-002 (analysis)

- **Acceptance Criteria**:
  - [ ] All 7 VT/VA artifacts passing
  - [ ] `just test` passing (all existing + new tests)
  - [ ] `just lint` and `just pylint` passing
  - [ ] Manual test: create phase for IP-002, verify correct metadata
  - [ ] Manual test: `show delta DE-002` displays all 3 phases
  - [ ] No regressions in existing delta/plan functionality

## 7. Risks & Mitigations
- **Risk**: Template changes break existing phases – *Likelihood*: low – *Impact*: medium – *Mitigation*: Don't modify existing phase files, only affect new creations
- **Risk**: Phase numbering logic conflicts with manual edits – *Likelihood*: medium – *Impact*: low – *Mitigation*: Scan filesystem for actual files, warn on gaps
- **Risk**: Formatter changes make delta display unreadable with many phases – *Likelihood*: low – *Impact*: medium – *Mitigation*: Truncate objectives, test with 1/3/5/10 phases
- **Risk**: Schema validation too strict, rejects valid phases – *Likelihood*: low – *Impact*: high – *Mitigation*: Follow existing validation patterns, test with real phase files

## 8. Follow-ups & Tracking
- **Future Phases / Deltas**: Phase status tracking, gate validation, list/show commands (separate delta when needed)
- **Backlog Items**: None identified yet
- **Open Decisions / Questions**:
  - Should phase creation update plan frontmatter automatically? ~~(Decision: No for MVP, manual sync acceptable)~~ **[Updated 2025-11-03]** Yes - moved to Phase 04 scope to ensure JSON output consistency
  - Phase numbering gaps: error or warning? (Decision: Warning, allow flexibility)

## 9. Implementation Notes
- Follow existing patterns in `supekku/cli/create.py` for command structure
- Reuse template rendering from `supekku/scripts/lib/core/templates.py`
- Phase directory location: `change/deltas/{delta-slug}/phases/`
- Phase file naming: `phase-01.md`, `phase-02.md` (zero-padded two digits)
- Reference IP-002 for real-world phase examples

### Phase 05 Completion (2025-11-03)
**Structured Progress Tracking with File Path Traceability**

Implemented `phase.tracking@v1` YAML block - a comprehensive enhancement beyond original scope:
- **Core tracking**: Tasks with status (pending/in_progress/completed/blocked), entrance/exit criteria with boolean completion
- **File path tracking**: Phase-level (references, context) and task-level (added/modified/removed/tests)
- **Validation**: 19 comprehensive tests, clear error messages, optional fields for backward compat
- **Live usage**: Phase-05 self-dogfoods tracking block, shows `[8/8 tasks - 100%]` in delta display

**Key decisions**:
- Tracking block optional initially (will become required after proven)
- Renamed `examples` → `context` for semantic clarity
- File paths support glob patterns in context field
- Formatter checks tracking first, falls back to regex for phases without tracking

**Files modified**:
- `supekku/scripts/lib/blocks/plan.py` - schema, parser, validator
- `supekku/scripts/lib/formatters/change_formatters.py` - formatter integration
- `supekku/templates/phase.md` - updated with tracking examples
- `supekku/scripts/lib/blocks/tracking_test.py` - new test file (19 tests)

**Quality**: Ruff clean, pylint 9.48/10, 1199 tests passing, backward compatible

Phase 05 complete. Ready for use in all future phases.
