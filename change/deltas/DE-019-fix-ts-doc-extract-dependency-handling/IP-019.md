---
id: IP-019
slug: fix-ts-doc-extract-dependency-handling
name: Implementation Plan - Fix ts-doc-extract dependency handling
created: '2025-11-08'
updated: '2025-11-08'
status: draft
kind: plan
aliases: []
---

```yaml supekku:plan.overview@v1
schema: supekku.plan.overview
version: 1
plan: IP-019
delta: DE-019
revision_links:
  aligns_with:
  - DR-019
specs:
  primary:
  - SPEC-124
  collaborators: []
requirements:
  targets: []
  dependencies: []
phases:
- id: IP-019.PHASE-01
  name: Phase 01 - npm_utils module (TDD)
  objective: Create supekku/scripts/lib/core/npm_utils.py module with comprehensive test coverage using TDD approach
  entrance_criteria:
    - DR-019 design revision reviewed and approved
    - IP-019 implementation plan complete
    - Development environment ready (uv, python, linters configured)
  exit_criteria:
    - npm_utils.py module complete with all planned functions
    - npm_utils_test.py achieves 100% test coverage
    - All tests passing (pytest)
    - Lint passing (ruff + pylint)
    - Code reviewed against DR-019 specification
- id: IP-019-P02
  name: Phase 02 - TypeScriptAdapter refactor
  objective: Update TypeScriptAdapter to use npm_utils, add dependency validation
  entrance_criteria:
    - Phase 1 complete (npm_utils module available)
    - All Phase 1 tests passing
  exit_criteria:
    - TypeScriptAdapter refactored to use npm_utils
    - Removed duplicate package manager detection code
    - Added _ensure_ts_doc_extract_available() method
    - All TypeScriptAdapter tests updated and passing
    - Manual sync test succeeds with and without ts-doc-extract
- id: IP-019-P03
  name: Phase 03 - Installer & final verification
  objective: Add optional dependency checking to installer, run full verification
  entrance_criteria:
    - Phase 2 complete (TypeScriptAdapter refactored)
    - All existing tests passing
  exit_criteria:
    - Installer warns about missing ts-doc-extract in TypeScript projects
    - Integration test added for sync with missing ts-doc-extract
    - All lint/tests pass (just quickcheck)
    - Manual verification complete for all package managers
```

```yaml supekku:verification.coverage@v1
schema: supekku.verification.coverage
version: 1
subject: IP-019
entries:
  - artefact: VT-019-001
    kind: VT
    requirement: npm_utils_package_detection
    status: planned
    notes: Unit tests for package manager detection, availability checks, command building
  - artefact: VT-019-002
    kind: VT
    requirement: typescript_adapter_graceful_degradation
    status: planned
    notes: Unit tests for TypeScriptAdapter handling missing ts-doc-extract
  - artefact: VT-019-003
    kind: VT
    requirement: typescript_sync_integration
    status: planned
    notes: Integration test for sync with missing ts-doc-extract
  - artefact: VT-019-004
    kind: VT
    requirement: existing_typescript_tests
    status: planned
    notes: Update existing TypeScriptAdapter tests to mock npm_utils
```

## 1. Summary
- **Delta**: DE-019 - Fix ts-doc-extract dependency handling
- **Specs Impacted**: SPEC-124 (sync adapters)
- **Problems / Issues**: ISSUE-021 (silent hang when ts-doc-extract missing)
- **Desired Outcome**: TypeScript sync validates ts-doc-extract availability upfront, uses `--yes` flags to prevent install prompts, skips gracefully with actionable warning if missing

## 2. Context & Constraints
- **Current Behaviour**: `spec-driver sync` hangs indefinitely on TypeScript files when ts-doc-extract npm package not installed (typescript.py:352-415)
- **Target Behaviour**:
  - Validate ts-doc-extract before processing TypeScript files
  - Use correct auto-install syntax: `npx --yes`, `pnpm dlx --package=X X`, `bunx --yes`
  - Skip TypeScript processing with warning if missing, don't fail entire sync
  - Centralize npm utilities for reuse by installer and future doctor command
- **Dependencies**: None
- **Constraints**:
  - Must support npm, pnpm, and bun package managers
  - Must support both local (node_modules/.bin/) and global installations
  - All changes backward compatible (no breaking changes to sync behavior when ts-doc-extract is installed)

## 3. Gate Check
- [x] Backlog items linked and prioritised (ISSUE-021)
- [x] Spec(s) updated or delta specifies required changes (SPEC-124 impacted, DR-019 complete)
- [x] Test strategy identified (TDD for npm_utils, update TypeScriptAdapter tests, add integration test)
- [x] Workspace/config changes assessed (none required)

## 4. Phase Overview

| Phase | Objective | Entrance Criteria | Exit Criteria / Done When | Phase Sheet |
| --- | --- | --- | --- | --- |
| Phase 1 - npm_utils module (TDD) | Create core npm utilities with comprehensive tests | DR-019 approved | npm_utils.py complete with 100% test coverage, all tests passing | `phases/phase-01.md` |
| Phase 2 - TypeScriptAdapter refactor | Update TypeScriptAdapter to use npm_utils, add dependency validation | Phase 1 complete | TypeScriptAdapter refactored, tests updated/passing, manual sync test succeeds | `phases/phase-02.md` |
| Phase 3 - Installer & final verification | Add optional dependency checking to installer, run full verification | Phase 2 complete | Installer warns about missing deps, all lint/tests pass, integration test added | `phases/phase-03.md` |

## 5. Phase Detail Snapshot
- **Research Notes**: Research complete, documented in DR-019 Section 6
- **Design Revision**: `DR-019.md` (approved)
- **Active Phase Sheet**: TBD (create with `spec-driver create phase --plan IP-019`)
- **Parallelisable Work**: None (phases are sequential due to dependencies)
- **Plan Updates**: Will update if new risks discovered during implementation

## 6. Testing & Verification Plan

### Unit Tests (TDD approach)

**New: `supekku/scripts/lib/core/npm_utils_test.py`**
- Test package manager detection from lockfiles (pnpm-lock.yaml, bun.lockb, package-lock.json, yarn.lock)
- Test detection defaults to npm when no lockfile found
- Test availability checks (`is_npm_available()`, `is_pnpm_available()`, `is_bun_available()`)
- Test `PackageManagerInfo` creation for each package manager
- Test `build_npx_command()` generates correct syntax:
  - npm: `["npx", "--yes", "ts-doc-extract"]`
  - pnpm: `["pnpm", "dlx", "--package=ts-doc-extract", "ts-doc-extract"]`
  - bun: `["bunx", "--yes", "ts-doc-extract"]`
- Test `is_npm_package_available()` checks local then global
- Test `get_install_instructions()` generates correct messages

**Updated: `supekku/scripts/lib/sync/adapters/typescript_test.py`**
- Mock `npm_utils` functions
- Test `_ensure_ts_doc_extract_available()` caching behavior
- Test graceful skip when ts-doc-extract not available
- Test warning message includes correct install instructions
- Test `_build_npx_command()` delegates to npm_utils
- Update existing tests to mock new dependencies

### Integration Tests

**New: Integration test for sync with missing ts-doc-extract**
- Set up fixture TypeScript project
- Mock `is_npm_package_available()` to return False
- Run sync command
- Verify warning printed with install instructions
- Verify sync exits successfully (doesn't fail)
- Verify no TypeScript contracts generated

### Manual Verification

- Test sync with ts-doc-extract installed (should work as before)
- Test sync without ts-doc-extract (should skip gracefully)
- Test with each package manager (npm, pnpm, bun)
- Test installer in TypeScript project (should warn about missing ts-doc-extract)

### Rollback Plan
If issues discovered post-merge: revert commits, restore previous TypeScriptAdapter behavior.

### Verification Coverage
All entries in `supekku:verification.coverage@v1` block must be completed before delta closure.

## 7. Risks & Mitigations

| Risk | Mitigation | Owner |
| --- | --- | --- |
| Package manager command syntax changes in future versions | Document syntax in DR-019, add version checks if needed | Dev |
| Local vs global detection fails in edge cases | Comprehensive testing of both installation types | Dev |
| Existing TypeScriptAdapter tests break during refactor | Update tests incrementally, run after each change | Dev |
| Performance regression from availability checks | Cache checks per adapter instance (already in design) | Dev |

## 8. Open Questions & Decisions

All questions resolved in DR-019 design phase.

## 9. Progress Tracking
- [ ] Phase 1 complete (npm_utils module)
- [ ] Phase 2 complete (TypeScriptAdapter refactor)
- [ ] Phase 3 complete (installer updates)
- [ ] All unit tests passing
- [ ] All integration tests passing
- [ ] Lint passing (ruff + pylint)
- [ ] Manual verification complete

## 10. Notes / Links
- Design Revision: [DR-019.md](./DR-019.md)
- Delta: [DE-019.md](./DE-019.md)
- Issue: backlog/issues/ISSUE-021-fix-ts-doc-extract-dependency-handling/ISSUE-021.md
- Spec: specify/tech/SPEC-124/SPEC-124.md
